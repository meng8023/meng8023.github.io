---
title: OAuth 2.0
tags: TeXt
key: 20190824
---

OAuth 2.0
===============

前言
--------

	OAuth 1.0已经在IETF尘埃落定，编号是RFC5849
	这也标志着OAuth已经正式成为互联网标准协议。
	OAuth 2.0早已经开始讨论和建立的草案。OAuth2.0很可能是下一代的“用户验证和授权”标准。现在百度开放平台，腾讯开放平台等大部分的开放平台都是使用的OAuth 2.0协议作为支撑。
	OAuth（开放授权）是一个开放标准，允许用户让第三方应用访问该用户在某一网站上存储的私密的资源（如照片，视频，联系人列表），而无需将用户名和密码提供给第三方应用。
	OAuth
	允许用户提供一个令牌，而不是用户名和密码来访问他们存放在特定服务提供者的数据。每一个令牌授权一个特定的网站（例如，视频编辑网站)在特定的时段（例如，接下来的2小时内）内访问特定的资源（例如仅仅是某一相册中的视频）。这样，OAuth允许用户授权第三方网站访问他们存储在另外的服务提供者上的信息，而不需要分享他们的访问许可或他们数据的所有内容。
	OAuth是OpenID的一个补充，但是完全不同的服务。
	OAuth 2.0
	是OAuth协议的下一版本，但不向后兼容OAuth 1.0。 OAuth 2.0关注客户端开发者的简易性，同时为Web应用，桌面应用和手机，和起居室设备提供专门的认证流程。2012年10月，OAuth 2.0协议正式发布为RFC 6749 [1]  。
	Facebook的新的Graph API只支持OAuth 2.0，Google在2011年3月亦宣布Google API对OAuth 2.0的支持。

认证授权过程
------------

	在认证和授权的过程中涉及的三方包括：
	1、服务提供方，用户使用服务提供方来存储受保护的资源，如照片，视频，联系人列表。
	2、用户，存放在服务提供方的受保护的资源的拥有者。
	3、客户端，要访问服务提供方资源的第三方应用，通常是网站，如提供照片打印服务的网站。在认证过程之前，客户端要向服务提供者申请客户端标识。
	使用OAuth进行认证和授权的过程如下所示:
	用户想操作存放在服务提供方的资源。
	用户登录客户端向服务提供方请求一个临时令牌。
	服务提供方验证客户端的身份后，授予一个临时令牌。
	客户端获得临时令牌后，将用户引导至服务提供方的授权页面请求用户授权。在这个过程中将临时令牌和客户端的回调连接发送给服务提供方。
	用户在服务提供方的网页上输入用户名和密码，然后授权该客户端访问所请求的资源。
	授权成功后，服务提供方引导用户返回客户端的网页。
	客户端根据临时令牌从服务提供方那里获取访问令牌。
	服务提供方根据临时令牌和用户的授权情况授予客户端访问令牌。
	客户端使用获取的访问令牌访问存放在服务提供方上的受保护的资源。
	
	
OpenID Connect
--------------
<https://openid.net/specs/openid-connect-core-1_0.html>

1. 简介
	OpenID 连接 1.0 是 OAuth 2.0 顶部的简单标识层[RFC6749]协议。它使客户端能够根据授权服务器执行的身份验证验证最终用户的身份，并可以以类似 REST 的互操作性方式获取有关最终用户的基本配置文件信息。
	OpenID Connect Core 1.0 规范定义了核心 OpenID 连接功能：在 OAuth 2.0 之上构建的身份验证，以及使用声明来传达有关最终用户的信息。它还介绍了使用 OpenID 连接的安全和隐私注意事项。
	作为背景，OAuth 2.0 授权框架[RFC6749] 和OAuth 2.0 承载令牌使用[RFC6750] 规范为第三方应用程序提供了获取和使用对 HTTP 资源的有限访问权限的一般框架。它们定义获取和使用访问令牌访问资源的机制，但不定义提供标识信息的标准方法。值得注意的是，如果不分析 OAuth 2.0，它无法提供有关最终用户身份验证的信息。读者应熟悉这些规范。
	OpenID Connect 实现身份验证，作为 OAuth 2.0 授权过程的扩展。客户端通过在授权请求中包含开放范围值来请求使用此扩展。有关执行的身份验证的信息在JSON Web 令牌 （JWT）[JWT] 称为 ID 令牌（请参阅第 2 部分).OAuth 2.0 身份验证服务器实现 OpenID 连接也称为 OpenID 提供程序 （IP）。使用 OpenID 连接的 OAuth 2.0 客户端也称为依赖方 （RPs）。
	此规范假定依赖方已获取有关 OpenID 提供程序的配置信息，包括其授权终结点和令牌终结点位置。此信息通常通过发现获得，如开放ID连接发现1.0[开放ID.发现]，或通过其他机制获得。
	同样，此规范假定依赖方已获得足够的凭据，并提供了使用 OpenID 提供程序所需的信息。这通常通过动态注册完成，如OpenID 连接动态客户端注册 1.0[开放ID.注册]，或通过其他机制获得。
	1.1. 要求表示法和公约
		本文档中的"必须"、"不得"、"必需"、"SHALL"、""不"、"应该"、"不应"、"推荐"、"不推荐"、"MAY"和"可选"等关键词应解释为RFC 2119[RFC2119]。
		在本文档的 .txt 版本中，引用值以指示要逐字取走。在协议消息中使用这些值时，不得将引号用作值的一部分。在本文档的 HTML 版本中，要采用的值通过使用此固定宽度字体来表示。
		所有用途JSON Web 签名 （JWS）[JWS] 和JSON 网络加密 （JWE）本规范中[JWE]数据结构采用JWS紧凑型序列化或JWE紧凑型序列化;不使用 JWS JSON 序列化和 JWE JSON 序列化。
	1.2. 术语
		此规范使用术语"访问令牌"、"授权代码"、"授权终结点"、"授权授予"、"授权服务器"、"客户端"、"客户端身份验证"、"客户端标识符"、"客户端机密"、"授权类型"、"受保护资源"、"重定向 URI"、"刷新令牌"、"资源所有者"、"资源服务器"、"响应类型"和"令牌终结点"定义OAuth 2.0[RFC6749]，术语"声明名称"、"声明值"、"JSON Web 令牌 （JWT）"、"JWT 声明集"和"嵌套 JWT"定义JSON Web 令牌 （JWT）[JWT]，术语"标题参数"和"JOSE头"定义JSON Web 签名 （JWS）[JWS]，术语"用户代理"定义RFC 2616[RFC2616]，以及定义的"响应模式"一词OAuth 2.0 多个响应类型编码实践[OAuth.响应]。
		此规范还定义了以下术语：
		认证
		用于在实体和呈现的标识之间实现对绑定的充分置信的过程。
		身份验证请求
		OAuth 2.0 授权请求使用 OpenID Connect 定义的扩展参数和作用域请求最终用户由授权服务器（OpenID 连接提供程序）对客户端（是 OpenID 连接依赖方）进行身份验证。
		身份验证上下文
		依赖方在就身份验证响应做出授权决策之前可能需要的信息。此类上下文可以包括但不限于实际使用的身份验证方法或保证级别，例如ISO/IEC 29115[ISO29115] 实体身份验证保证级别。
		身份验证上下文类
		在特定上下文中被视为彼此等效的身份验证方法或过程集。
		身份验证上下文类引用
		身份验证上下文类的标识符。
		授权代码流
		OAuth 2.0 流，其中授权代码从授权终结点返回，所有令牌从令牌终结点返回。
		授权请求
		OAuth 2.0 授权请求，由[RFC6749].
		索赔
		断言的实体信息。
		索赔类型
		用于表示声明值的语法。此规范定义正常、聚合和分布式声明类型。
		声明提供程序
		可以返回有关实体的声明的服务器。
		凭据
		作为使用身份或其他资源的权利的证据提供的数据。
		最终用户
		人类参与者。
		实体
		具有单独和独特的存在，并且可以在上下文中识别的东西。最终用户是实体的一个示例。
		基本索赔
		客户端指定的声明对于确保最终用户请求的特定任务获得顺利授权体验是必要的。
		混合流
		OAuth 2.0 流，其中授权代码从授权终结点返回，某些令牌从授权终结点返回，而其他令牌从令牌终结点返回。
		ID 令牌
		JSON Web 令牌 （JWT）包含有关身份验证事件的声明的 [JWT]。它可能包含其他声明。
		标识符
		在特定上下文中唯一描述实体的值。
		身份
		与实体相关的属性集。
		隐式流
		OAuth 2.0 流，其中所有令牌都从授权终结点返回，并且不使用令牌终结点或授权代码。
		发行
		发出一组声明的实体。
		颁发者标识符
		颁发者可验证的标识符。颁发者标识符是使用https方案的区分大小写 URL，该方案包含方案、主机和可选的端口号和路径组件，并且没有查询或片段组件。
		消息
		在 OpenID 依赖方和 OpenID 提供程序之间请求或响应。
		开放ID提供程序 （OP）
		OAuth 2.0 授权服务器，能够对最终用户进行身份验证，并提供有关身份验证事件和最终用户的声明。
		请求对象
		包含一组请求参数作为其声明的 JWT。
		请求 URI
		引用包含请求对象的资源的 URL。请求 URI 内容必须由授权服务器检索。
		成对假名标识符 （PPID）
		标识依赖方的实体与另一依赖方的 PPID 不能相关的实体的标识符。
		个人身份信息 （PII）
		（a） 可用于识别与此类信息有关的自然人的信息，或 （b） 与与此类信息有关的自然人直接或间接联系的信息。
		依赖方 （RP）
		OAuth 2.0 客户端应用程序，需要来自 OpenID 提供程序的最终用户身份验证和声明。
		扇区标识符
		依赖方组织使用的 URL 的主机组件，该 URL 是计算该依赖方的成对主题标识符的输入。
		自颁发开放ID提供程序
		颁发自签名 ID 令牌的个人、自托管的 OpenID 提供程序。
		主题标识符
		本地唯一且从未重新分配的最终用户颁发者标识符，该标识符旨在供客户端使用。
		用户信息终结点
		受保护资源，当客户端提供访问令牌时，返回由相应的授权授予表示的最终用户的授权信息。UserInfo 终结点 URL 必须使用https方案，并且可能包含端口、路径和查询参数组件。
		验证
		旨在建立构造的健全性或正确性的过程。
		验证
		旨在测试或证明事实或价值的真实性或准确性的过程。
		自愿索赔
		客户端指定为对最终用户请求的特定任务有用但不重要的声明。

		读者注意：本节中的术语定义是本规范的规范部分，对实现施加要求。此规范文本中的所有大写词（如"颁发者标识符"）都引用这些定义的术语。每当读者遇到他们时，都必须遵循本节中的定义。
		有关使用的某些术语的更多背景信息，请参阅互联网安全词汇表，版本 2[RFC4949]，ISO/IEC 29115 实体身份验证保证[ISO29115]，以及ITU-T X.1252[X.1252]。

1.3. 概述
	抽象的 OpenID 连接协议遵循以下步骤。

	RP（客户端）向 OpenID 提供程序 （OP） 发送请求。
	OP 对最终用户进行身份验证并获得授权。
	OP 使用 ID 令牌（通常是访问令牌）进行响应。
	RP 可以使用访问令牌将请求发送到用户信息终结点。
	UserInfo 终结点返回有关最终用户的声明。

	以下图说明了这些步骤：
	+--------+                                   +--------+
	|        |                                   |        |
	|        |---------(1) AuthN Request-------->|        |
	|        |                                   |        |
	|        |  +--------+                       |        |
	|        |  |        |                       |        |
	|        |  |  End-  |<--(2) AuthN & AuthZ-->|        |
	|        |  |  User  |                       |        |
	|   RP   |  |        |                       |   OP   |
	|        |  +--------+                       |        |
	|        |                                   |        |
	|        |<--------(3) AuthN Response--------|        |
	|        |                                   |        |
	|        |---------(4) UserInfo Request----->|        |
	|        |                                   |        |
	|        |<--------(5) UserInfo Response-----|        |
	|        |                                   |        |
	+--------+                                   +--------+

2. ID 令牌
	OpenID Connect 对 OAuth 2.0 进行的主要扩展是 ID 令牌数据结构，使最终用户能够进行身份验证。ID 令牌是一种安全令牌，其中包含有关使用客户端时授权服务器对最终用户进行身份验证的声明，以及可能的其他请求的声明。ID 令牌表示为JSON Web 令牌 （JWT）[JWT]。
	对于 OpenID Connect 使用的所有 OAuth 2.0 流，在 ID 令牌中使用以下声明：

	Iss
	必填。响应的颁发者标识符。iss值是使用https方案的区分大小写 URL，该方案包含方案、主机和可选的端口号和路径组件，并且没有查询或片段组件。
	子
	必填。主题标识符。最终用户的颁发者中本地唯一且从未重新分配的标识符，该标识符旨在供客户端使用，例如，24400320或AItOawmwtWwcT0k51BayewNvutrJUqsvl6qs7A4。长度不得超过 255 个 ASCII 字符。子值是区分大小写的字符串。
	澳元
	必填。此 ID 令牌用于的受众。它必须包含依赖方的 OAuth 2.0客户端_id作为访问对象值。它还可能包含其他访问群体的标识符。在一般情况下，aud值是区分大小写的字符串的数组。在通常的特殊情况中，当有一个访问群体时，aud 值可能是单个区分大小写的字符串。
	exp
	必填。过期时间，其中不允许 ID 令牌进行处理。此参数的处理要求当前日期/时间必须早于值中列出的到期日期/时间。实施者可能提供一些小回旋余地（通常不超过几分钟）来考虑时钟偏差。其值是一个 JSON 编号，表示从 1970-01-01T0：0：0Z 到日期/时间为止的秒数。看到RFC 3339[RFC3339] 有关日期/时间的详细信息，特别是 UTC。
	Iat
	必填。发出 JWT 的时间。其值是一个 JSON 编号，表示从 1970-01-01T0：0：0Z 到日期/时间为止的秒数。
	时间
	最终用户身份验证发生的时间。其值是一个 JSON 编号，表示从 1970-01-01T0：0：0Z 到日期/时间为止的秒数。当提出最高年龄请求或请求"时间"作为基本索赔时，则此索赔为必填项项;否则，其包含是可选的。（在语义上对应于 OpenID 2.0 的auth_time声明佩普[开放ID.PAPE] auth_时间响应参数。
	Nonce
	用于将客户端会话与 ID 令牌相关联的字符串值，并缓解重播攻击。该值通过未修改的身份验证请求传递到 ID 令牌。如果 ID 令牌中存在，客户端必须验证nonce声明值是否等于身份验证请求中发送的nonce参数的值。如果存在于身份验证请求中，授权服务器必须在 ID 令牌中包含一个nonce声明，声明值是身份验证请求中发送的 nonce 值。授权服务器不应对使用的nonce值执行其他处理。nonce值是区分大小写的字符串。
	Acr
	选。身份验证上下文类引用。指定身份验证上下文类引用值的字符串，该值标识执行的身份验证满足的身份验证上下文类。值"0"表示最终用户身份验证不符合ISO/IEC 29115[ISO29115] 级别 1。例如，使用长期存在的浏览器 Cookie 进行身份验证是适合使用"级别 0"的一个示例。级别为 0 的身份验证不应用于授权访问任何货币价值的任何资源。（这对应于 OpenID 2.0佩普[开放ID.PAPE] nist_auth_级别0.） 绝对 URI 或RFC 6711[RFC6711] 注册名称应用作acr值;注册名称不得以与注册名称不同的含义使用。使用此声明的各方需要商定所用值的含义，这些值可能是特定于上下文的。acr值是区分大小写的字符串。
	Amr
	选。身份验证方法引用。JSON 字符串的 JSON 数组，它们是身份验证方法的标识符。例如，值可能表示同时使用了密码和 OTP 身份验证方法。要在amr声明中使用的特定值的定义超出了此规范的范围。使用此声明的各方需要商定所用值的含义，这些值可能是特定于上下文的。amr值是区分大小写字符串的数组。
	阿兹普
	选。授权方 - 颁发 ID 令牌的一方。如果存在，则必须包含此方的 OAuth 2.0 客户端 ID。仅当 ID 令牌具有单个访问群体值且访问群体与授权方不同时，才需要此声明。即使授权方与唯一的受众相同，也可能包括它。azp值是包含 StringOrURI 值的区分大小写字符串。

	ID 令牌可能包含其他声明。必须忽略使用的任何未理解的声明。请参阅部分3.1.3.6,3.3.2.11,5.1和7.4有关此规范定义的其他声明。
	必须使用 ID 令牌进行签名JWS[JWS] 和可选的两签名，然后加密使用JWS[JWS] 和JWE[JWE] 从而提供身份验证、完整性、不可否认性以及可选的保密性。第16.14节.如果 ID 令牌已加密，则必须对其进行签名，然后进行加密，其结果是嵌套 JWT，在[JWT].ID 令牌不得将none用作alg值，除非使用的响应类型从授权终结点返回无 ID 令牌（例如，在使用授权代码流时），并且客户端显式请求在注册时间。
	ID令牌不应使用JWS或JWE x5u、x5c、jku或jwk标头参数字段。相反，使用"发现"和"注册"参数提前传达对所用密钥的引用。Section 10.
	以下是 ID 令牌中声明集（JWT 声明集）的非规范示例：
	  {
	   "iss": "https://server.example.com",
	   "sub": "24400320",
	   "aud": "s6BhdRkqt3",
	   "nonce": "n-0S6_WzA2Mj",
	   "exp": 1311281970,
	   "iat": 1311280970,
	   "auth_time": 1311280969,
	   "acr": "urn:mace:incommon:iap:silver"
	  }
